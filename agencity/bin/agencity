#!/usr/bin/env bash
#
# agencity — Terminal-native talent intelligence
#
# Usage:
#   agencity start        Start the Agencity engine (Python API + OpenClaw gateway)
#   agencity stop         Stop all Agencity processes
#   agencity chat         Interactive chat with the Agencity agent
#   agencity search       Quick one-shot search (delegates to OpenClaw agent)
#   agencity doctor       Health check
#   agencity status       Show running processes
#   agencity gateway      Start only the OpenClaw gateway
#   agencity api          Start only the Python FastAPI server
#
set -euo pipefail

# ── Paths ──────────────────────────────────────────────────────────────────────
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
AGENCITY_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# OpenClaw resolution order:
#   1. OPENCLAW_ROOT env var (explicit override)
#   2. vendor/openclaw/ (embedded — recommended)
#   3. ../../openclaw-fork (sibling directory — legacy)
#   4. ~/openclaw-fork (home directory — legacy fallback)
if [ -n "${OPENCLAW_ROOT:-}" ] && [ -f "$OPENCLAW_ROOT/openclaw.mjs" ]; then
  : # Use explicit OPENCLAW_ROOT
elif [ -f "$AGENCITY_ROOT/vendor/openclaw/openclaw.mjs" ]; then
  OPENCLAW_ROOT="$AGENCITY_ROOT/vendor/openclaw"
elif [ -f "$AGENCITY_ROOT/../../openclaw-fork/openclaw.mjs" ]; then
  OPENCLAW_ROOT="$(cd "$AGENCITY_ROOT/../../openclaw-fork" && pwd)"
else
  OPENCLAW_ROOT="${OPENCLAW_ROOT:-$HOME/openclaw-fork}"
fi

PIDFILE_API="$AGENCITY_ROOT/.agencity-api.pid"
PIDFILE_GATEWAY="$AGENCITY_ROOT/.agencity-gateway.pid"
LOGDIR="$AGENCITY_ROOT/logs"

# ── Config ─────────────────────────────────────────────────────────────────────
export AGENCITY_API_BASE="${AGENCITY_API_BASE:-http://localhost:8001}"
export AGENCITY_API_PORT="${AGENCITY_API_PORT:-8001}"
export OPENCLAW_CONFIG_PATH="${OPENCLAW_CONFIG_PATH:-$AGENCITY_ROOT/openclaw.config.json}"
export OPENCLAW_STATE_DIR="${OPENCLAW_STATE_DIR:-$HOME/.openclaw}"

# ── Helpers ────────────────────────────────────────────────────────────────────
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

log()   { echo -e "${BLUE}[agencity]${NC} $*"; }
ok()    { echo -e "${GREEN}[agencity]${NC} $*"; }
warn()  { echo -e "${YELLOW}[agencity]${NC} $*"; }
err()   { echo -e "${RED}[agencity]${NC} $*" >&2; }

is_running() {
  local pidfile="$1"
  if [ -f "$pidfile" ]; then
    local pid
    pid=$(cat "$pidfile")
    if kill -0 "$pid" 2>/dev/null; then
      return 0
    fi
    rm -f "$pidfile"
  fi
  return 1
}

wait_for_url() {
  local url="$1"
  local timeout="${2:-30}"
  local i=0
  while [ $i -lt "$timeout" ]; do
    if curl -sf "$url" >/dev/null 2>&1; then
      return 0
    fi
    sleep 1
    i=$((i + 1))
  done
  return 1
}

# ── Commands ───────────────────────────────────────────────────────────────────

cmd_start() {
  log "Starting Agencity..."
  mkdir -p "$LOGDIR"

  # Start Python FastAPI
  if is_running "$PIDFILE_API"; then
    ok "Python API already running (pid $(cat "$PIDFILE_API"))"
  else
    log "Starting Python API on port $AGENCITY_API_PORT..."
    cd "$AGENCITY_ROOT"
    python -m uvicorn app.main:app \
      --host 0.0.0.0 \
      --port "$AGENCITY_API_PORT" \
      --log-level info \
      > "$LOGDIR/api.log" 2>&1 &
    echo $! > "$PIDFILE_API"

    if wait_for_url "$AGENCITY_API_BASE/health" 15; then
      ok "Python API started (pid $(cat "$PIDFILE_API"))"
    else
      err "Python API failed to start. Check $LOGDIR/api.log"
      return 1
    fi
  fi

  # Start OpenClaw gateway
  if is_running "$PIDFILE_GATEWAY"; then
    ok "OpenClaw gateway already running (pid $(cat "$PIDFILE_GATEWAY"))"
  else
    if [ ! -f "$OPENCLAW_ROOT/openclaw.mjs" ]; then
      err "OpenClaw not found at $OPENCLAW_ROOT"
      err "Run: ./scripts/setup-openclaw.sh"
      return 1
    fi

    log "Starting OpenClaw gateway..."
    cd "$OPENCLAW_ROOT"
    node openclaw.mjs gateway run \
      --port 18789 \
      > "$LOGDIR/gateway.log" 2>&1 &
    echo $! > "$PIDFILE_GATEWAY"
    sleep 2

    if is_running "$PIDFILE_GATEWAY"; then
      ok "OpenClaw gateway started (pid $(cat "$PIDFILE_GATEWAY"))"
    else
      err "OpenClaw gateway failed to start. Check $LOGDIR/gateway.log"
      return 1
    fi
  fi

  echo ""
  ok "${BOLD}Agencity is ready!${NC}"
  echo ""
  echo -e "  ${CYAN}agencity chat${NC}     — Talk to the agent"
  echo -e "  ${CYAN}agencity search${NC}   — Quick candidate search"
  echo -e "  ${CYAN}agencity doctor${NC}   — Health check"
  echo -e "  ${CYAN}agencity stop${NC}     — Shut everything down"
  echo ""
}

cmd_stop() {
  log "Stopping Agencity..."

  if is_running "$PIDFILE_GATEWAY"; then
    kill "$(cat "$PIDFILE_GATEWAY")" 2>/dev/null || true
    rm -f "$PIDFILE_GATEWAY"
    ok "Gateway stopped"
  else
    log "Gateway not running"
  fi

  if is_running "$PIDFILE_API"; then
    kill "$(cat "$PIDFILE_API")" 2>/dev/null || true
    rm -f "$PIDFILE_API"
    ok "API stopped"
  else
    log "API not running"
  fi

  ok "Agencity stopped"
}

cmd_status() {
  echo -e "${BOLD}Agencity Status${NC}"
  echo ""

  if is_running "$PIDFILE_API"; then
    ok "Python API:      running (pid $(cat "$PIDFILE_API"))"
  else
    warn "Python API:      not running"
  fi

  if is_running "$PIDFILE_GATEWAY"; then
    ok "OpenClaw Gateway: running (pid $(cat "$PIDFILE_GATEWAY"))"
  else
    warn "OpenClaw Gateway: not running"
  fi

  echo ""

  # Quick health check
  if curl -sf "$AGENCITY_API_BASE/health" >/dev/null 2>&1; then
    ok "API Health:      healthy"
  else
    warn "API Health:      unreachable"
  fi
}

cmd_chat() {
  # Ensure services are running
  if ! is_running "$PIDFILE_API"; then
    warn "API not running. Starting services first..."
    cmd_start
  fi

  if [ ! -f "$OPENCLAW_ROOT/openclaw.mjs" ]; then
    err "OpenClaw not found at $OPENCLAW_ROOT"
    err "Run: ./scripts/setup-openclaw.sh"
    return 1
  fi

  cd "$OPENCLAW_ROOT"

  if [ $# -gt 0 ]; then
    # One-shot message
    node openclaw.mjs agent --local --message "$*"
  else
    # Interactive — send to TUI
    node openclaw.mjs tui
  fi
}

cmd_search() {
  # Ensure API is running
  if ! curl -sf "$AGENCITY_API_BASE/health" >/dev/null 2>&1; then
    warn "API not reachable. Starting..."
    cmd_api_start
    echo ""
  fi

  if [ ! -f "$OPENCLAW_ROOT/openclaw.mjs" ]; then
    err "OpenClaw not found. Run: ./scripts/setup-openclaw.sh"
    return 1
  fi

  local message="Search for candidates"
  if [ $# -gt 0 ]; then
    message="$*"
  else
    echo -e "${CYAN}What role are you hiring for?${NC}"
    read -r message
    message="Find candidates for: $message"
  fi

  cd "$OPENCLAW_ROOT"
  node openclaw.mjs agent --local --message "$message"
}

cmd_doctor() {
  echo -e "${BOLD}Agencity Doctor${NC}"
  echo ""

  # Check Python
  if command -v python3 &>/dev/null; then
    ok "Python:     $(python3 --version 2>&1)"
  else
    err "Python:     not found"
  fi

  # Check Node
  if command -v node &>/dev/null; then
    ok "Node.js:    $(node --version)"
  else
    err "Node.js:    not found"
  fi

  # Check OpenClaw
  if [ -f "$OPENCLAW_ROOT/openclaw.mjs" ]; then
    OPENCLAW_VERSION=$(cat "$AGENCITY_ROOT/.openclaw-version" 2>/dev/null || echo "unknown")
    ok "OpenClaw:   found at $OPENCLAW_ROOT (version: $OPENCLAW_VERSION)"
  else
    err "OpenClaw:   not found — run ./scripts/setup-openclaw.sh"
  fi

  # Check Agencity root
  if [ -f "$AGENCITY_ROOT/app/main.py" ]; then
    ok "Agencity:   found at $AGENCITY_ROOT"
  else
    err "Agencity:   app/main.py not found"
  fi

  echo ""

  # Check API health
  if curl -sf "$AGENCITY_API_BASE/health" >/dev/null 2>&1; then
    ok "API:        healthy at $AGENCITY_API_BASE"
    echo ""
    curl -sf "$AGENCITY_API_BASE/health" | python3 -m json.tool 2>/dev/null || true
  else
    warn "API:        not running at $AGENCITY_API_BASE"
  fi

  echo ""

  # Check env vars
  echo -e "${BOLD}Environment${NC}"
  [ -n "${ANTHROPIC_API_KEY:-}" ] && ok "ANTHROPIC_API_KEY: set" || warn "ANTHROPIC_API_KEY: not set"
  [ -n "${OPENAI_API_KEY:-}" ]    && ok "OPENAI_API_KEY:    set" || warn "OPENAI_API_KEY:    not set"
  [ -n "${SUPABASE_URL:-}" ]      && ok "SUPABASE_URL:      set" || warn "SUPABASE_URL:      not set"
  [ -n "${PDL_API_KEY:-}" ]       && ok "PDL_API_KEY:       set" || warn "PDL_API_KEY:       not set"
  [ -n "${CLADO_API_KEY:-}" ]     && ok "CLADO_API_KEY:     set" || warn "CLADO_API_KEY:     not set"

  # Check .env file
  if [ -f "$AGENCITY_ROOT/.env" ]; then
    ok ".env file:  found"
  else
    warn ".env file:  not found (create $AGENCITY_ROOT/.env)"
  fi
}

cmd_api_start() {
  if is_running "$PIDFILE_API"; then
    ok "Python API already running (pid $(cat "$PIDFILE_API"))"
    return 0
  fi

  mkdir -p "$LOGDIR"
  log "Starting Python API on port $AGENCITY_API_PORT..."
  cd "$AGENCITY_ROOT"
  python -m uvicorn app.main:app \
    --host 0.0.0.0 \
    --port "$AGENCITY_API_PORT" \
    --log-level info \
    > "$LOGDIR/api.log" 2>&1 &
  echo $! > "$PIDFILE_API"

  if wait_for_url "$AGENCITY_API_BASE/health" 15; then
    ok "Python API started (pid $(cat "$PIDFILE_API"))"
  else
    err "Python API failed to start. Check $LOGDIR/api.log"
    return 1
  fi
}

cmd_gateway_start() {
  if is_running "$PIDFILE_GATEWAY"; then
    ok "OpenClaw gateway already running (pid $(cat "$PIDFILE_GATEWAY"))"
    return 0
  fi

  if [ ! -f "$OPENCLAW_ROOT/openclaw.mjs" ]; then
    err "OpenClaw not found at $OPENCLAW_ROOT"
    err "Run: ./scripts/setup-openclaw.sh"
    return 1
  fi

  mkdir -p "$LOGDIR"
  log "Starting OpenClaw gateway..."
  cd "$OPENCLAW_ROOT"
  node openclaw.mjs gateway run --port 18789 \
    > "$LOGDIR/gateway.log" 2>&1 &
  echo $! > "$PIDFILE_GATEWAY"
  sleep 2

  if is_running "$PIDFILE_GATEWAY"; then
    ok "OpenClaw gateway started (pid $(cat "$PIDFILE_GATEWAY"))"
  else
    err "Gateway failed to start. Check $LOGDIR/gateway.log"
    return 1
  fi
}

cmd_help() {
  echo ""
  echo -e "${BOLD}Agencity${NC} — Terminal-native talent intelligence"
  echo ""
  echo -e "${BOLD}Usage:${NC}"
  echo -e "  agencity ${CYAN}<command>${NC} [options]"
  echo ""
  echo -e "${BOLD}Commands:${NC}"
  echo -e "  ${CYAN}start${NC}       Start the full Agencity stack (API + Gateway)"
  echo -e "  ${CYAN}stop${NC}        Stop all Agencity processes"
  echo -e "  ${CYAN}status${NC}      Show running process status"
  echo -e "  ${CYAN}chat${NC}        Interactive chat with the Agencity agent"
  echo -e "  ${CYAN}search${NC}      Quick candidate search"
  echo -e "  ${CYAN}doctor${NC}      Run health checks and diagnostics"
  echo -e "  ${CYAN}api${NC}         Start only the Python FastAPI server"
  echo -e "  ${CYAN}gateway${NC}     Start only the OpenClaw gateway"
  echo -e "  ${CYAN}help${NC}        Show this help"
  echo ""
  echo -e "${BOLD}Examples:${NC}"
  echo -e "  agencity start"
  echo -e "  agencity chat"
  echo -e "  agencity search \"Founding Engineer with Python and React\""
  echo -e "  agencity doctor"
  echo ""
  echo -e "${BOLD}Environment:${NC}"
  echo -e "  AGENCITY_API_BASE     API URL (default: http://localhost:8001)"
  echo -e "  AGENCITY_API_PORT     API port (default: 8001)"
  echo -e "  AGENCITY_COMPANY_ID   Default company UUID"
  echo -e "  OPENCLAW_ROOT         Path to OpenClaw (default: vendor/openclaw)"
  echo ""
}

# ── Main ───────────────────────────────────────────────────────────────────────

# Source .env if it exists
if [ -f "$AGENCITY_ROOT/.env" ]; then
  set -a
  # shellcheck disable=SC1091
  source "$AGENCITY_ROOT/.env"
  set +a
fi

COMMAND="${1:-help}"
shift 2>/dev/null || true

case "$COMMAND" in
  start)    cmd_start "$@" ;;
  stop)     cmd_stop "$@" ;;
  status)   cmd_status "$@" ;;
  chat)     cmd_chat "$@" ;;
  search)   cmd_search "$@" ;;
  doctor)   cmd_doctor "$@" ;;
  api)      cmd_api_start "$@" ;;
  gateway)  cmd_gateway_start "$@" ;;
  help|-h|--help)  cmd_help ;;
  *)
    err "Unknown command: $COMMAND"
    cmd_help
    exit 1
    ;;
esac
